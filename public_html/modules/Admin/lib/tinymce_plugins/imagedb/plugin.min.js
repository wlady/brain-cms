tinymce.PluginManager.add("imagedb",function(d){function c(g,i){var f=document.createElement("img");function e(k,j){f.parentNode.removeChild(f);i({width:k,height:j})}f.onload=function(){e(f.clientWidth,f.clientHeight)};f.onerror=function(){e()};f.src=g;var h=f.style;h.visibility="hidden";h.position="fixed";h.bottom=h.left=0;h.width=h.height="auto";document.body.appendChild(f)}function b(e){return function(){var f=d.settings.image_list;if(typeof(f)=="string"){tinymce.util.XHR.send({url:f,success:function(g){e(tinymce.util.JSON.parse(g))}})}else{e(f)}}}function a(z){var g,J,B=d.dom,f=d.selection.getNode();var y,r,j,t,D;if(!d.settings.imagedbthumbler){d.windowManager.alert("Please define imagedbthumbler");return}function G(){var h=[{text:"None",value:""}];tinymce.each(z,function(q){h.push({text:q.text||q.title,value:q.value||q.url,menu:q.menu})});return h}function e(L){var q,K,w,h;q=g.find("#width")[0];K=g.find("#height")[0];w=q.value();h=K.value();if(g.find("#constrain")[0].checked()&&y&&r&&w&&h){if(L.control==q){h=Math.round((w/y)*h);K.value(h)}else{w=Math.round((h/r)*w);q.value(w)}}y=w;r=h}function m(){function h(L){function K(){L.onload=L.onerror=null;d.selection.select(L);d.nodeChanged()}L.onload=function(){if(!q.width&&!q.height){B.setAttribs(L,{width:L.clientWidth,height:L.clientHeight})}K()};L.onerror=K}var q=g.toJSON();if(q.width===""){q.width=null}if(q.height===""){q.height=null}if(q.style===""){q.style=null}var w="";if(q.w!==""){w+="&w="+q.w}if(q.h!==""){w+="&h="+q.h}if(q.q!==""){w+="&q="+q.q}if(q.sx!==""){w+="&sx="+q.sx}if(q.sy!==""){w+="&sy="+q.sy}if(q.sw!==""){w+="&sw="+q.sw}if(q.sh!==""){w+="&sh="+q.sh}if(q.aoe){w+="&aoe="+q.aoe}if(q.zc){w+="&zc="+q.zc}q={src:d.settings.imagedbthumbler+q.img_id+w,alt:q.alt,width:q.width,height:q.height,style:q.style};d.undoManager.transact(function(){if(!q.src){if(f){B.remove(f);d.nodeChanged()}return}if(!f){q.id="__mcenew";d.selection.setContent(B.createHTML("img",q));f=B.get("__mcenew");B.setAttrib(f,"id",null)}else{B.setAttribs(f,q)}h(f)})}function I(h){if(h){h=h.replace(/px$/,"")}return h}function E(){c(this.value(),function(h){if(h.width&&h.height){y=h.width;r=h.height;g.find("#width").value(y);g.find("#height").value(r)}})}y=B.getAttrib(f,"width");r=B.getAttrib(f,"height");var u,l,A,p,o,n,s,H,i,k;j=B.getAttrib(f,"src");var C=/\?id=(\d+)/i;var x=j.match(C);if(x&&x.length>1){u=x[1]}C=/w=(\d+)/i;x=j.match(C);if(x&&x.length>1){l=x[1]}C=/h=(\d+)/i;x=j.match(C);if(x&&x.length>1){A=x[1]}C=/q=(\d+)/i;x=j.match(C);if(x&&x.length>1){p=x[1]}C=/sx=(\d+)/i;x=j.match(C);if(x&&x.length>1){o=x[1]}C=/sy=(\d+)/i;x=j.match(C);if(x&&x.length>1){n=x[1]}C=/sw=(\d+)/i;x=j.match(C);if(x&&x.length>1){s=x[1]}C=/sh=(\d+)/i;x=j.match(C);if(x&&x.length>1){H=x[1]}C=/aoe=(\d+)/i;x=j.match(C);if(x&&x.length>1){if(x[1]){i=x[1]}}C=/zc=(\d+)/i;x=j.match(C);if(x&&x.length>1){if(x[1]){k=x[1]}}if(f.nodeName=="IMG"&&!f.getAttribute("data-mce-object")){J={img_id:u,alt:B.getAttrib(f,"alt"),width:y,height:r,w:l,h:A,q:p,sx:o,sy:n,sw:s,sh:H,aoe:i,zc:k}}else{f=null}if(z){D={name:"target",type:"listbox",label:"Image list",values:G(),onselect:function(h){var q=g.find("#alt");if(!q.value()||(h.lastControl&&q.value()==h.lastControl.text())){q.value(h.control.text())}g.find("#img_id").value(h.control.value())}}}var F=[{name:"img_id",type:"filepicker",filetype:"imagedb",label:"Image ID",autofocus:true,onchange:E},D,{name:"alt",type:"textbox",label:"Image description",subtype:"imagedescr"},{type:"container",label:"Dimensions",layout:"flex",direction:"row",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:3,size:3,onchange:e},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:3,size:3,onchange:e},{name:"constrain",type:"checkbox",checked:true,text:"Constrain proportions"}]}];function v(){function w(K){if(K.length>0&&/^[0-9]+$/.test(K)){K+="px"}return K}var q=g.toJSON();var h=B.parseStyle(q.style);B.setAttrib(f,"style","");delete h.margin;h["margin-top"]=h["margin-bottom"]=w(q.vspace);h["margin-left"]=h["margin-right"]=w(q.hspace);h["border-width"]=w(q.border);g.find("#style").value(B.serializeStyle(B.parseStyle(B.serializeStyle(h))))}if(d.settings.image_advtab){if(f){J.hspace=I(f.style.marginLeft||f.style.marginRight);J.vspace=I(f.style.marginTop||f.style.marginBottom);J.border=I(f.style.borderWidth);J.style=d.dom.serializeStyle(d.dom.parseStyle(d.dom.getAttrib(f,"style")))}g=d.windowManager.open({title:"Insert/edit DB image",data:J,bodyType:"tabpanel",body:[{title:"General",type:"form",items:F},{title:"Advanced",type:"form",pack:"start",items:[{label:"Style",name:"style",type:"textbox"},{type:"form",layout:"grid",packV:"start",columns:2,padding:0,alignH:["left","right"],defaults:{type:"textbox",maxWidth:50,onchange:v},items:[{label:"Vertical space",name:"vspace"},{label:"Horizontal space",name:"hspace"},{label:"Border",name:"border"}]}]},{title:"Thumbler",type:"form",items:[{label:"Width (w)",name:"w",type:"textbox"},{label:"Height (h)",name:"h",type:"textbox"},{label:"Quality (q)",name:"q",type:"textbox"},{label:"Offset X (sy)",name:"sx",type:"textbox"},{label:"Offset Y (sy)",name:"sy",type:"textbox"},{label:"Crop to X (sw)",name:"sw",type:"textbox"},{label:"Crop to Y (sh)",name:"sh",type:"textbox"},{label:"Enable enlarge (aoe)",name:"aoe",type:"listbox",text:"No",values:[{text:"Yes",value:"1"},{text:"No",value:""},]},{label:"Zoom Crop (zc)",name:"zc",type:"listbox",text:"No",values:[{text:"Yes",value:"1"},{text:"No",value:""},]}]}],onSubmit:m})}else{g=d.windowManager.open({title:"Insert/edit DB image",data:J,body:F,onSubmit:m})}}d.addButton("imagedb",{icon:"icon-images",tooltip:"Insert/edit DB image",onclick:b(a),stateSelector:"img:not([data-mce-object])"});d.addMenuItem("imagedb",{icon:"icon-images",text:"Insert DB image",onclick:b(a),context:"insert",prependToContext:true})});